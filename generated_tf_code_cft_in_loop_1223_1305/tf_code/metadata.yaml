# Generated by AI. May require manual review.
apiVersion: blueprints.cloud.google.com/v1alpha1
kind: TerraformBlueprint
metadata:
  name: terraform-google-app-engine-version
  source:
    type: git
    git:
      repo: https://github.com/GoogleCloudPlatform/terraform-google-app-engine-version.git # Example repo
      dir: /
  version: 1.0.0
spec:
  info:
    title: Google Cloud App Engine Version
    actuationTool:
      type: Terraform
      versions:
      - ">= 1.3.0"
    description:
      tagline: Deploys a new version to a Google Cloud App Engine service.
      detailed: This module handles the deployment of a new version to a Google Cloud App Engine service, supporting both Standard and Flexible environments. It can optionally create the App Engine application itself.
    icon: # path/to/icon.svg
    diagrams:
    - name: architecture
      # path/to/architecture.png
      description: A high-level diagram showing the resources created by this blueprint.
    documentations:
    - title: Module Usage
      # url: # URL to official documentation
      description: Detailed guide on how to use this Terraform module.
    examples:
    - name: simple_standard_app
      # path: /examples/simple_standard_app
      description: A basic example of deploying a standard environment App Engine version.
    - name: simple_flex_app
      # path: /examples/simple_flex_app
      description: A basic example of deploying a flexible environment App Engine version.
  requirements:
    roles:
    - level: Project
      roles:
      - roles/appengine.admin
      - roles/iam.serviceAccountUser
      - roles/storage.objectViewer
    services:
    - appengine.googleapis.com
    - cloudbuild.googleapis.com
    - compute.googleapis.com
    - storage.googleapis.com
    - vpcaccess.googleapis.com
  customization:
    variables:
    - name: project_id
      description: The ID of the Google Cloud project that the App Engine application belongs to.
      type: string
      required: true
    - name: service_name
      description: The name of the service to deploy.
      type: string
      required: true
    - name: version_id
      description: The version ID for the new deployment.
      type: string
      required: true
    - name: runtime
      description: The runtime environment for the application. For example, 'python311' or 'nodejs20'.
      type: string
      required: true
    - name: env_type
      description: The App Engine environment type. Must be one of 'standard' or 'flex'.
      type: string
      required: true
    - name: deployment
      description: "Deployment configuration for the app version. For a standard environment, this should be a map with a 'zip' block containing 'source_url'. For a flexible environment, it can contain either a 'zip' block or a 'container' block with 'image'. Example for standard: { zip = { source_url = \"gs://my-bucket/my-app.zip\" } }. Example for flex: { container = { image = \"gcr.io/google-appengine/python-hello-world\" } }. Note: When using a 'zip' deployment with 'source_url', the deploying principal must have 'Storage Object Viewer' (roles/storage.objectViewer) permissions on the GCS bucket."
      type: object
      required: true
    - name: entrypoint
      description: The entrypoint for the application, which is required for all deployments. This should be a map containing a 'shell' key with the command string. Example: { shell = "gunicorn -b :$PORT main:app" }
      type: object
      required: true
    - name: location_id
      description: The location to serve the App Engine application from. Required if create_app is true.
      type: string
      required: false
      default: null
    - name: create_app
      description: If true, creates the App Engine application. This is a one-time operation per project.
      type: bool
      required: false
      default: true
    - name: service_account
      description: The service account to be used for the application. If not provided, the App Engine default service account is used. It is recommended to use a dedicated service account with least privileges.
      type: string
      required: false
      default: null
    - name: env_variables
      description: A map of environment variables to forward to the application.
      type: map(string)
      required: false
      default: {}
    - name: inbound_services
      description: A list of inbound services for the App Engine version. Allowed values are 'INBOUND_SERVICE_MAIL', 'INBOUND_SERVICE_MAIL_BOUNCE', 'INBOUND_SERVICE_XMPP_ERROR', 'INBOUND_SERVICE_XMPP_MESSAGE', 'INBOUND_SERVICE_XMPP_SUBSCRIBE', 'INBOUND_SERVICE_XMPP_PRESENCE', 'INBOUND_SERVICE_CHANNEL_PRESENCE', and 'INBOUND_SERVICE_WARMUP'.
      type: list(string)
      required: false
      default: null
    - name: instance_class
      description: Instance class that is used to run this version. Valid values are F1, F2, F4, F4_1G, B1, B2, B4, B8, B4_1G. (Standard environment only)
      type: string
      required: false
      default: null
    - name: standard_scaling
      description: "Scaling settings for the standard environment. This should be a map containing exactly one of the following keys: 'automatic_scaling', 'basic_scaling', or 'manual_scaling'. The value should be an object with the settings for that scaling type."
      type: object
      required: false
      default: {}
    - name: flex_settings
      description: "A map of settings specific to the flexible environment. The 'liveness_check' and 'readiness_check' blocks are required by App Engine Flex. If not specified, default check paths will be used. Can also contain optional keys for 'resources', 'network', 'automatic_scaling', and 'vpc_access_connector'."
      type: object
      required: false
      default: {}
    - name: delete_service_on_destroy
      description: If set to true, the service will be deleted when the app version is destroyed. (Standard environment only)
      type: bool
      required: false
      default: false
    - name: noop_on_destroy
      description: If set to true, the app version will not be deleted when the resource is destroyed. This is useful for managing traffic splits.
      type: bool
      required: false
      default: false
    variableGroups:
    - name: Required Settings
      description: Core configuration required for any App Engine version deployment.
      variables:
      - project_id
      - service_name
      - version_id
      - runtime
      - env_type
      - deployment
      - entrypoint
    - name: Application Settings
      description: General settings for the App Engine application and version.
      variables:
      - location_id
      - create_app
      - service_account
      - env_variables
      - inbound_services
    - name: Standard Environment Settings
      description: Configuration specific to the App Engine Standard environment.
      variables:
      - instance_class
      - standard_scaling
    - name: Flexible Environment Settings
      description: Configuration specific to the App Engine Flexible environment.
      variables:
      - flex_settings
    - name: Lifecycle Management
      description: Controls the behavior of the resources when they are destroyed.
      variables:
      - delete_service_on_destroy
      - noop_on_destroy
    outputs:
    - name: name
      description: The full resource name of the deployed App Engine version.
    - name: service
      description: The name of the service the version was deployed to.
    - name: version_id
      description: The ID of the deployed version.
